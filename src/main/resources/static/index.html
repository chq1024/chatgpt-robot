<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>HTTP/2 Server Push Example</title>
</head>
<body>
<h1>CHAT</h1>
<button id="newChatBtn">new chat</button>
<button id="closeChatBtn">close</button>
<hr>
<div class="mainContent">
  <div class="qaContent">
    <embed src="/svg/question-person.svg" type="image/svg+xml" /><input placeholder="请输入" type="text" id="ic" oninput="autoResizeInput(this)"/>
  </div>
</div>

<div id="pushedData" class="preLine"></div>

<script>
  let currChatCk = "";

  const pushedDataElement = document.getElementById('pushedData');
  const newChatBtnElement = document.getElementById('newChatBtn');
  const icInputElement = document.getElementById("ic");


  newChatBtnElement.addEventListener('click', () => {
      // currChatCk = generateRandomString();
      send()
  });

  icInputElement.addEventListener("keyup",(event) =>{
    if (event.key === "Enter") {
      send()
    }
  })

  async function send() {
    const requestData = {
      ck: currChatCk,
      content: "给我一个随机数"
    };

    // Send the HTTP/2 POST request using fetch
    const response = await fetch('/api/chat', {
      method: 'POST',
      body: JSON.stringify(requestData),
      headers: {
        'Accept': '*/*',
        'Content-Type': 'application/json',
      },
      referrerPolicy: 'no-referrer',
    });
    console.log(response)
    if (response.ok) {
      // Handle successful response
      const text = await response.text();
      // pushedDataElement.textContent = `Server Pushed Data: ${text}`;
      //   pushedDataElement.textContent = `Server Pushed Data: ${text}`;
      const item = JSON.parse(text);
      currChatCk = item.ck
      pushedDataElement.innerText = JSON.stringify(item.content) + "\r\n"
    } else {
      // Handle error
      console.error('Error:', response.status);
      // const text = await response.text();
      // pushedDataElement.textContent = `Server Pushed Data: ${text}`;
    }
  }

  // 监听sse api
  const evenListen = new EventSource("/api/sse");
  evenListen.addEventListener("message",(event)=>{
    console.log("event:",event)
    pushedDataElement.innerText += event.data + "\r\n"
  })
  evenListen.addEventListener('error', (event) => {
    console.error('连接关闭：', event);
  });

  function autoResizeInput(input) {
    input.style.width = input.value.length + "ch"; // 使用输入内容的长度来设置宽度
  }
</script>
<style>
  .preLine {
    white-space: pre-line;
  }
  .qaContent {
    display: flex;
    justify-content: end;
  }
  #ic {
    border: none;
    outline: none;
    min-width: 200px;
    box-sizing: border-box;
  }
</style>
</body>
</html>
